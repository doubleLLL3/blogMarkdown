---
title: 'åŸºäºæ–‡ä»¶çš„è¿›ç¨‹é—´é€šä¿¡â€”â€”ç”¨100ä¸ªè¿›ç¨‹æŠ¢ç®—ç´¯åŠ å’Œ'
date: 2021-01-20 18:00:00
tags: [è®¡ç®—æœº,æ“ä½œç³»ç»Ÿ,Linux,ç½‘ç»œç³»ç»Ÿ,æµ·è´¼ç­]
published: true
hideInList: false
feature: 
isTop: false
---
# éœ€æ±‚æè¿°

1. è®¾ç½®ä¸€ä¸ªå¹¶å‘åº¦`INS`ï¼Œè¡¨ç¤ºè¦å¼€çš„è¿›ç¨‹æ•°é‡
2. ä½¿ç”¨è¿™`INS`ä¸ªè¿›ç¨‹ï¼Œè®¡ç®—ä»`start`åˆ°`end`ä¹‹é—´çš„æ•°å­—ç´¯åŠ å’Œ
3. `start`å’Œ`end`é€šè¿‡`getopt`è§£æå‘½ä»¤è¡Œå‚æ•°è·å–
```shell
./a.out -s 12 -e 24
```
4. è¾“å‡ºä¸€ä¸ªæ•´å‹ç»“æœï¼š`sum`

[æ³¨æ„]

* ä¸»è¦æ¶‰åŠæ–‡ä»¶åŠè¿›ç¨‹ç›¸å…³æ“ä½œ
* ä½¿ç”¨**æ–‡ä»¶**è¿›è¡Œæ•°æ®å…±äº«ï¼Œéœ€è¦è€ƒè™‘æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰
* å°è¯•ä½¿ç”¨**æ–‡ä»¶é”**æ¥æ¨¡æ‹Ÿçº¿ç¨‹ä¹‹é—´çš„äº’æ–¥é”
* é€šè¿‡æ–‡ä»¶é”å®ç°**ä¸´ç•Œæ•°æ®**ï¼ˆå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ç«äº‰ä¿®æ”¹çš„æ•°æ®ï¼‰çš„åŒæ­¥è®¿é—®
* éœ€è¦å­¦ä¹ flockï¼šman 2 flock
# æœ€ç»ˆç»“æœ

* ç”¨100ä¸ªè¿›ç¨‹ç®—1åˆ°1000çš„ç´¯åŠ å’Œï¼Œæ•ˆæœæˆªå–å¦‚ä¸‹ï¼š
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/p8eeZaCl4w0RyYqj.png" alt="å›¾ç‰‡" style="zoom: 50%;" />
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/7T4s12m7a779ozZJ.png" alt="å›¾ç‰‡" style="zoom: 50%;" />
    * æˆåŠŸè®©è¿›ç¨‹ä»¬åœ¨åŒä¸€å—æ•°æ®ä¸ŠæŠ¢ç€è®¡ç®—ç´¯åŠ å’Œ
# å®ç°è¿‡ç¨‹

## æ€è·¯æµç¨‹å›¾

* <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/20210120114829.png" alt="å›¾ç‰‡" style="zoom: 50%;" />
* æŠŠæ¡å¥½çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„ä»»åŠ¡
* å…³é”®ï¼šå¤šè¿›ç¨‹è®¿é—®åŒä¸€æ–‡ä»¶çš„åŠ é”æ“ä½œï¼Œè®©è¯»å†™æ•°æ®æˆä¸ºâ€œåŸå­æ“ä½œâ€ [ä¸å¯åˆ†å‰²çš„æœ€å°å•ä½]
    * å¯ä»¥ç†è§£ä¸ºåŸå­æ“ä½œï¼Œä½†æ˜¯æœ¬è´¨ä¸Šåªæ˜¯è®©æ•°æ®çš„è¯»å†™è¿‡ç¨‹å®Œæ•´
    * è¿›ç¨‹å¯èƒ½å› ä¸ºæ—¶é—´ç‰‡ç”¨å®Œè€Œä¸­æ–­ï¼Œä½†å› ä¸ºé”çš„å­˜åœ¨ï¼Œæ­¤æ—¶å…¶å®ƒè¿›ç¨‹è¿˜æ— æ³•è®¿é—®è¿™äº›æ•°æ®
## è·å–å‘½ä»¤è¡Œå‚æ•°

æ•è·-sã€-eé€‰é¡¹ï¼Œä½¿ç”¨è¯¥é€‰é¡¹å¿…é¡»å¸¦å‚æ•°

```c++
#include "head.h"
int main(int argc, char **argv) {
Â  Â  int opt, start = 0, end = 0;
Â  Â  while ((opt = getopt(argc, argv, "s:e:")) != -1) {
Â  Â  Â  Â  switch (opt) {
Â  Â  Â  Â  Â  Â  case 's':
Â  Â  Â  Â  Â  Â  Â  Â  start = atoi(optarg);Â  // atoi: å­—ç¬¦ä¸²->æ•´æ•°
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'e':
Â  Â  Â  Â  Â  Â  Â  Â  end = atoi(optarg);
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  fprintf(stderr, "Usage : %s -s start_num -e end_num\n", argv[0]);
Â  Â  Â  Â  Â  Â  Â  Â  exit(1);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  printf("start = %d\nend = %d\n", start, end);
    return 0;
}
```
* å¤´æ–‡ä»¶"head.h"è§æœ«å°¾
* atoiï¼šå­—ç¬¦ä¸²ğŸ‘‰æ•´æ•°ï¼Œoptargæ˜¯å­—ç¬¦æ•°ç»„
* æ•ˆæœå¦‚ä¸‹ï¼š
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/bKVavgRRUftGE7LR.png" alt="å›¾ç‰‡" style="zoom:67%;" />
    * ğŸ†—
## åˆ›å»ºINSä¸ªè¿›ç¨‹

ä½¿ç”¨forkåˆ›å»ºINSä¸ªè¿›ç¨‹ï¼Œæ³¨æ„ä½¿ç”¨waité˜²æ­¢åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿ

```c++
#define INS 100
pid_t pid;
int x = 0;Â        // x: ç¬¬å‡ å·è¿›ç¨‹
for (int i = 1; i <= INS; i++) {
Â  Â  if ((pid = fork()) < 0) {
Â  Â  Â  Â  perror("fork");
Â  Â  Â  Â  exit(1);Â  // åªæ˜¯å›¾æ–¹ä¾¿ï¼Œå·¥ä½œä¸­ä¸å¦‚æ­¤æ“ä½œ
Â  Â  }
Â  Â  if (pid == 0) {
Â  Â  Â  Â  x = i;Â    // ç»™å­è¿›ç¨‹ç¼–å·
Â  Â  Â  Â  break;Â    // å…³é”®ï¼Œå¦åˆ™ä¼šä¸æ–­å¥—å¨ƒ
Â  Â  }
}
if (pid != 0) {
Â  Â  // é˜²æ­¢äº§ç”Ÿåƒµå°¸è¿›ç¨‹ [ç­‰å¾…å®Œæ‰€æœ‰çš„å­è¿›ç¨‹]
Â  Â  for (int i = 1; i <= INS; i++) {
Â  Â  Â  Â  wait(NULL);
    }
    // çˆ¶è¿›ç¨‹
    printf("I'm parent!\n");  
} else {
Â  Â  printf("I'm %dth child!\n", x);
}
```
* è¯¥æ®µä»£ç æ”¾åœ¨ä¸»å‡½æ•°ä¸­è·å–å‘½ä»¤è¡Œå‚æ•°å
* INSå®šä¹‰ä¸ºå®
* å­è¿›ç¨‹åˆ›å»ºå¤±è´¥ç›´æ¥exit(1)ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œå·¥ä½œä¸­å¿Œ
* æ•ˆæœå¦‚ä¸‹ï¼š
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/WGnejU9xb8SUERCo.png" alt="å›¾ç‰‡" style="zoom:67%;" />
    * æˆåŠŸåˆ›å»º100ä¸ªå­è¿›ç¨‹
## åŸºäºæ–‡ä»¶çš„æ•°æ®è¯»å†™æ¥å£

ä½¿ç”¨æ–‡ä»¶ä½œä¸ºè¿›ç¨‹ä¹‹é—´å…±äº«æ•°æ®çš„è½½ä½“

* å¦‚ä½•åœ¨æ–‡ä»¶ä¸­å­˜å‚¨æ•°æ®ï¼ŸASCIIç  [å­—ç¬¦]ã€int [ä½16ä½+é«˜16ä½]...
* è¿™é‡Œä½¿ç”¨ç»“æ„ä½“å­˜å‚¨æ•°æ®ï¼Œç»“æ„æ¸…æ™°
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/20210120114943.png" alt="å›¾ç‰‡" style="zoom:67%;" />
    * å­˜å‚¨åŠ æ•°ã€å’Œæ•°
```c++
char data_file[] = "./.data";
char lock_file[] = "./.lock";Â  // [å¯é€‰] è®¾ç½®ä¸“é—¨çš„ä¸€æŠŠé”
// è¦ä¼ é€’çš„æ•°æ®
struct Msg {
Â  Â  int now;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // åŠ æ•°
Â  Â  int sum;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // å’Œ
};
struct Msg data;Â  Â  Â  Â  Â  Â  Â  Â // ç»“æ„ä½“æ•°æ®
// å†™å…¥ç»“æ„ä½“æ•°æ®
size_t set_data(struct Msg *msg) {
Â  Â  FILE *f = fopen(data_file, "w");Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // å†™
Â  Â  if (f == NULL) {
Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  return -1;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // åœ¨ä¸€ä¸ªå°å‡½æ•°é‡Œé¢exitè¿‡äºç²—é²
Â  Â  }
Â  Â  size_t nwrite = fwrite(msg, 1, sizeof(struct Msg), f);Â  // æ¯æ¬¡å†™1ä¸ªå­—èŠ‚
Â  Â  fclose(f);
Â  Â  return nwrite;Â  Â  Â  Â  Â  Â  Â // è¿”å›çš„æ˜¯æˆåŠŸå†™çš„å­—èŠ‚æ•°ï¼Œå¦‚æœå‡ºé”™ä¹Ÿè¿”å›ç»™ä¸Šå±‚
}
// è¯»å–ç»“æ„ä½“æ•°æ®
size_t get_data(struct Msg *msg) {
Â  Â  FILE *f = fopen(data_file, "r");
Â  Â  if (f == NULL) {
Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  return -1;
Â  Â  }
Â  Â  size_t nread = fread(msg, 1, sizeof(struct Msg), f);Â  Â  // è¯»å…¥ç»“æ„ä½“æ•°æ®åˆ°msgä¸­
Â  Â  fclose(f);
Â  Â  return nread;
}
```
* åˆ›å»ºå…¨å±€å˜é‡dataï¼Œç”¨æ¥åœ¨è¿›ç¨‹ä¸­æ“ä½œæ•°æ®
* åˆ©ç”¨æ ‡å‡†æ–‡ä»¶æ“ä½œï¼Œåº•å±‚æ–‡ä»¶æ“ä½œä¹Ÿå¯è¡Œ
* è¿”å›å€¼å¯ä¾›è°ƒç”¨è€…æ£€æŸ¥è¯»å†™æˆåŠŸä¸å¦
## åŠ å…¥é”â­

è®©è¿›ç¨‹æŠ¢ç€ç»´æŠ¤å…±äº«æ•°æ®ï¼Œå¹¶ä¿æŠ¤æ•°æ®æ–‡ä»¶ä¸è¢«åŒæ—¶æ“ä½œ

ã€ä¸¤ç§æ€è·¯ã€‘ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶ï¼›ä½¿ç”¨ä¸¤ä¸ªæ–‡ä»¶

* **æ€è·¯ä¸€**ï¼šç›´æ¥å¯¹æ•°æ®æ–‡ä»¶åŠ é”
```c++
char data_file[] = "./.data";
// åšåŠ æ³• [åŸå­æ“ä½œï¼šè¯» + å†™]ï¼›endï¼šåŠ æ³•åœæ­¢æ¡ä»¶ï¼›idï¼šå­©å­çš„ç¼–å· [å¯ç”¨ä¸Šå¸è§†è§’ç›‘æ§]
void do_add(int end, int id) {
Â  Â  // å­©å­ä¸€ç›´åœ¨é‡Œé¢åšåŠ æ³•
Â  Â  while (1) {
        /*
Â  Â  Â  Â  Â * æ€è·¯ä¸€ï¼šä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥åœ¨æ•°æ®æ–‡ä»¶åŠ é”
Â  Â  Â  Â  Â */
Â  Â  Â  Â  // æ‰“å¼€data_fileç”¨æ¥åŠ é”
Â  Â  Â  Â  FILE *f = fopen(data_file, "r");
Â  Â  Â  Â  // åŠ äº’æ–¥é”
Â  Â  Â  Â  flock(f->_fileno, LOCK_EX);
Â  Â  Â  Â  // ä»æ–‡ä»¶è¯»å–æ•°æ® [get_dataå‡½æ•°é‡Œä¼šå†æ¬¡æ‰“å¼€data_fileæ–‡ä»¶ï¼Œå¯¹åº”æ–°çš„fdï¼Œé”ä¸å…±ç”¨]
Â  Â  Â  Â  if (get_data(&data) < 0) continue;
Â  Â  Â  Â  // åŠ æ•°+1ï¼Œå¹¶åˆ¤æ–­åŠ æ•°æ˜¯å¦è¶…è¿‡èŒƒå›´
Â  Â  Â  Â  if (++data.now > end) {
Â  Â  Â  Â  Â  Â  fclose(f);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åšåŠ æ³•
Â  Â  Â  Â  data.sum += data.now;
Â  Â  Â  Â  printf("The <%d>th Child : now = %d, sum = %d\n", id, data.now, data.sum);
Â  Â  Â  Â  // å°†æ•°æ®å†™å…¥æ–‡ä»¶
Â  Â  Â  Â  if (set_data(&data) < 0) continue;
Â  Â  Â  Â  // è§£é” [åé¢å…³é—­å…¶å®ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾é”]
Â  Â  Â  Â  flock(fileno(f), LOCK_UN);
Â  Â  Â  Â  fclose(f);
Â  Â  }
}
```
* å‡½æ•°å‚æ•°ï¼šendä½œä¸ºåŠ æ³•çš„åœæ­¢æ¡ä»¶å‚ç…§ï¼Œidå¯ç”¨æ¥è§‚å¯Ÿæ¯æ¬¡åŠ æ³•æ˜¯å“ªä¸ªå­©å­ç®—çš„
* åŠ é” ğŸ‘‰ è§£é”ä¸­é—´çš„è¿‡ç¨‹å°±æ˜¯**åŸå­æ“ä½œ**[ä¸å¯åˆ†å‰²çš„æœ€å°å•ä½]
    * å°è£…äº†è¯»æ•°æ®ã€åšè®¡ç®—ã€å†™æ•°æ®æ“ä½œï¼Œè¿‡ç¨‹ä¸­æ•°æ®ä¸ä¼šè¢«æŠ¢å 
* ç”±æ–‡ä»¶æŒ‡é’ˆFILE* fè·å¾—æ–‡ä»¶æè¿°ç¬¦fd
    * â‘  f->_fileno
    * â‘¡ fileno(f)
* [PS]
    * é‡å¤æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ä¼šå¾—åˆ°ä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé”ä¹Ÿç›¸äº’ç‹¬ç«‹
    * æ–‡ä»¶å…³é—­ä¼šè‡ªåŠ¨é‡Šæ”¾é”
    * åœ¨æ¯æ¬¡è°ƒç”¨è¯»å†™æ¥å£åï¼Œåˆ©ç”¨å¥½è¿”å›å€¼åˆ¤æ–­æ“ä½œæˆåŠŸä¸å¦
* **æ€è·¯äºŒ**ï¼šè®¾ç½®ä¸“é—¨çš„æ–‡ä»¶åŠ é”
```c++
char data_file[] = "./.data";
char lock_file[] = "./.lock";Â  // è®¾ç½®ä¸“é—¨çš„ä¸€æŠŠé”
void do_add(int end, int id) {
Â  Â  while (1) {
Â  Â  Â  Â  /*
Â  Â  Â  Â  Â * æ€è·¯äºŒï¼šä¸¤ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨å•ç‹¬çš„æ–‡ä»¶ä½œä¸ºé” [æ›´æ˜“ç†è§£]
Â  Â  Â  Â  Â */
Â  Â  Â  Â  // æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªé”æ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²åŠ é”ï¼Œå°†ç­‰å¾…ä½¿ç”¨è€…è§£é”
Â  Â  Â  Â  FILE *lock = fopen(lock_file, "w");Â  // "w"ï¼šå¦‚æœä¸å­˜åœ¨æ–‡ä»¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª
Â  Â  Â  Â  if (lock == NULL) {
Â  Â  Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  Â  Â  exit(1);
Â  Â  Â  Â  }
Â  Â  Â  Â  // åŠ é”
Â  Â  Â  Â  flock(lock->_fileno, LOCK_EX);
Â  Â  Â  Â  // ä»æ–‡ä»¶è¯»å–æ•°æ®
Â  Â  Â  Â  if (get_data(&data) < 0) {
Â  Â  Â  Â  Â  Â  fclose(lock);Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å…³é—­é”æ–‡ä»¶ï¼Œé‡Šæ”¾é”
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åŠ æ•°+1ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³åœæ­¢åŠ çš„æ¡ä»¶
Â  Â  Â  Â  if (++data.now > end) {
Â  Â  Â  Â  Â  Â  fclose(lock);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åšåŠ æ³•
Â  Â  Â  Â  data.sum += data.now;
Â  Â  Â  Â  printf("The <%d>th Child : now = %d, sum = %d\n", id, data.now, data.sum);
Â  Â  Â  Â  // å°†æ•°æ®å†™å…¥æ–‡ä»¶
Â  Â  Â  Â  if (set_data(&data) < 0) continue;
Â  Â  Â  Â  // è§£é”
Â  Â  Â  Â  flock(lock->_fileno, LOCK_UN);
Â  Â  Â  Â  fclose(lock);
Â  Â  }
}
```
* lock_fileå°±æ˜¯å•çº¯ä¸ºäº†åšé”
* æ•ˆæœå¦‚ä¸‹ï¼šã€å•æ ¸ï¼Œ5ä¸ªè¿›ç¨‹ï¼Œè®¡ç®—1~100ã€‘
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/20210120115012.png" alt="å›¾ç‰‡" style="zoom:67%;" />
    * <img src="https://cdn.jsdelivr.net/gh/doubleLLL3/blogImgs@main/img/64LJ3MGJusPTvSSt.png" alt="å›¾ç‰‡" style="zoom:67%;" />
    * å•æ ¸çš„æ•ˆæœæ¯”å¤šæ ¸æ›´æ•´é½
        * å•æ ¸ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªè¿›ç¨‹
        * å¯ä»¥ä½¿ç”¨usleep()æå‰æŒ‚èµ·è¿›ç¨‹ï¼Œä¸è®©ä¸€ä¸ªè¿›ç¨‹è®¡ç®—é‚£ä¹ˆä¹…ï¼Œè®©é¡ºåºæ›´ä¹±
    * è‹¥å°†è¾“å‡ºä¼ ç»™moreï¼Œå®ƒä¼šå°†è¾“å‡ºæŒ‰è¿›ç¨‹åŒºåˆ†ï¼Œé‡æ–°æ’åˆ—å±•ç¤º
* ã€æ³¨æ„ã€‘
    * åœ¨ä¸»å‡½æ•°ä¸­ï¼Œå°†**æ•°æ®åˆå§‹å€¼**å…ˆå†™å…¥æ–‡ä»¶ï¼Œå¦åˆ™æ–‡ä»¶ä¸ºç©º [è¯¦è§å®Œæ•´ä»£ç ]
    * åœ¨ä¸»å‡½æ•°ï¼Œå­è¿›ç¨‹é€»è¾‘ä¸­è°ƒç”¨do_add()å‡½æ•°å³å¯ï¼Œçˆ¶è¿›ç¨‹é€»è¾‘ä¸­åœ¨ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸåä»æ•°æ®æ–‡ä»¶è·å–å¹¶è¾“å‡ºæœ€ç»ˆç»“æœå³å¯
* â— å¦‚æœä¸åŠ é”ï¼Œç»“æœä»ç„¶å¯¹
    * åŠ æ•°å’Œå’Œæ•°æ˜¯åŒ…è£…åœ¨ä¸€èµ·ï¼ŒåŠ æ³•ä¸ä¼šå‡ºé”™
    * ä½†æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå®Œæ•´åœ°ç®—ä¸€éç»“æœï¼Œå¯èƒ½æ˜¯ç¼“å†²åŒºçš„ç¼˜æ•…ï¼Ÿä¸æ˜¯
        * åœ¨æ‰€æœ‰å†™æ“ä½œåéƒ½åŠ å…¥fflushï¼Œå°½ç®¡æœ‰ä¸€äº›æ¥ç€ç®—çš„æƒ…å†µï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½è¿˜æ˜¯ä¼šè·‘åˆ°æœ€åçš„æ­£ç¡®ç»“æœ
        * ç›¸å½“äºæœ‰è¿›ç¨‹ç®—å®Œäº†ï¼Œæ•°æ®å†™å…¥æ–‡ä»¶ï¼Œä½†æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹è¯»å–çš„è¿˜ä¸æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œè¿˜ä¼šè‡ªå·±å†ç®—ä¸€éç´¯åŠ 
    * è§£é‡Š
        * å¤šä¸ªè¿›ç¨‹æ‰“å¼€åŒä¸€æ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„æ–‡ä»¶è¡¨é¡¹ï¼ˆfileå¯¹è±¡ï¼‰ï¼ŒåŒ…å«å®ƒè‡ªå·±çš„æ–‡ä»¶ä½ç§»é‡
        * æ‰€ä»¥å¯¹äºå¤šä¸ªè¿›ç¨‹è¯»åŒä¸€æ–‡ä»¶éƒ½èƒ½æ­£ç¡®å·¥ä½œï¼Œä½†å†™åŒä¸€æ–‡ä»¶å¯èƒ½äº§ç”Ÿé¢„æœŸä¸åˆ°çš„ç»“æœï¼Œå¯å‚è€ƒä½¿ç”¨preadã€pwrite
        * è¿˜å¯å‚è€ƒ[Linuxä¸‹å¤šè¿›ç¨‹åŒæ—¶æ“ä½œæ–‡ä»¶](https://www.cnblogs.com/fnlingnzb-learner/p/13030070.html)â€”â€”cnblogs
# å®Œæ•´ä»£ç 

## sum.c

```c++
#include "head.h"
#define INS 100
char data_file[] = "./.data";
char lock_file[] = "./.lock";Â  // [å¯é€‰] è®¾ç½®ä¸“é—¨çš„ä¸€æŠŠé”
// è¦ä¼ é€’çš„æ•°æ®
struct Msg {
Â  Â  int now;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // åŠ æ•°
Â  Â  int sum;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // å’Œ
};
struct Msg data;Â  Â  Â  Â  Â  Â  Â  Â // ç»“æ„ä½“æ•°æ®
// å†™å…¥ç»“æ„ä½“æ•°æ®
size_t set_data(struct Msg *msg) {
Â  Â  FILE *f = fopen(data_file, "w");Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // å†™
Â  Â  if (f == NULL) {
Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  return -1;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // åœ¨ä¸€ä¸ªå°å‡½æ•°é‡Œé¢exitè¿‡äºç²—é²
Â  Â  }
Â  Â  size_t nwrite = fwrite(msg, 1, sizeof(struct Msg), f);Â  // æ¯æ¬¡å†™1ä¸ªå­—èŠ‚
Â  Â  fclose(f);
Â  Â  return nwrite;Â  Â  Â  Â  Â  Â  Â // è¿”å›çš„æ˜¯æˆåŠŸå†™çš„å­—èŠ‚æ•°ï¼Œå¦‚æœå‡ºé”™ä¹Ÿè¿”å›ç»™ä¸Šå±‚
}
// è¯»å–ç»“æ„ä½“æ•°æ®
size_t get_data(struct Msg *msg) {
Â  Â  FILE *f = fopen(data_file, "r");
Â  Â  if (f == NULL) {
Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  return -1;
Â  Â  }
Â  Â  size_t nread = fread(msg, 1, sizeof(struct Msg), f);Â  Â  // è¯»å…¥ç»“æ„ä½“æ•°æ®åˆ°msgä¸­
Â  Â  return nread;
}
// åšåŠ æ³• [åŸå­æ“ä½œï¼šè¯» + å†™]ï¼›endï¼šåŠ æ³•åœæ­¢æ¡ä»¶ï¼›idï¼šå­©å­çš„ç¼–å· [å¯ç”¨ä¸Šå¸è§†è§’ç›‘æ§]
void do_add(int end, int id) {
Â  Â  // å­©å­ä¸€ç›´åœ¨é‡Œé¢åšåŠ æ³•
Â  Â  while (1) {
Â  Â  Â  Â  /*
Â  Â  Â  Â  Â * æ€è·¯äºŒï¼šä¸¤ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨å•ç‹¬çš„æ–‡ä»¶ä½œä¸ºé” [æ›´æ˜“ç†è§£]
Â  Â  Â  Â  Â */
Â  Â  Â  Â  // æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªé”æ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å·²åŠ é”ï¼Œå°†ç­‰å¾…ä½¿ç”¨è€…è§£é”
Â  Â  Â  Â  FILE *lock = fopen(lock_file, "w");Â  // "w"ï¼šå¦‚æœä¸å­˜åœ¨æ–‡ä»¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª
Â  Â  Â  Â  if (lock == NULL) {
Â  Â  Â  Â  Â  Â  perror("fopen");
Â  Â  Â  Â  Â  Â  exit(1);
Â  Â  Â  Â  }
Â  Â  Â  Â  // åŠ é”
Â  Â  Â  Â  flock(lock->_fileno, LOCK_EX);
Â  Â  Â  Â  // ä»æ–‡ä»¶è¯»å–æ•°æ®
Â  Â  Â  Â  if (get_data(&data) < 0) {
Â  Â  Â  Â  Â  Â  fclose(lock);Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å…³é—­é”æ–‡ä»¶ï¼Œé‡Šæ”¾é”
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åŠ æ•°+1ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³åœæ­¢åŠ çš„æ¡ä»¶
Â  Â  Â  Â  if (++data.now > end) {
Â  Â  Â  Â  Â  Â  fclose(lock);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åšåŠ æ³•
Â  Â  Â  Â  data.sum += data.now;
Â  Â  Â  Â  printf("The <%d>th Child : now = %d, sum = %d\n", id, data.now, data.sum);
Â  Â  Â  Â  // å°†æ•°æ®å†™å…¥æ–‡ä»¶
Â  Â  Â  Â  if (set_data(&data) < 0) continue;
Â  Â  Â  Â  // è§£é”
Â  Â  Â  Â  flock(lock->_fileno, LOCK_UN);
Â  Â  Â  Â  fclose(lock);
Â  Â  Â  Â  /*
Â  Â  Â  Â  Â * æ€è·¯ä¸€ï¼šä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥åœ¨æ•°æ®æ–‡ä»¶åŠ é”
Â  Â  Â  Â  Â */
Â  Â  Â  Â  /*
Â  Â  Â  Â  // æ‰“å¼€data_fileç”¨æ¥åŠ é”
Â  Â  Â  Â  FILE *f = fopen(data_file, "r");
Â  Â  Â  Â  // åŠ äº’æ–¥é”
Â  Â  Â  Â  flock(f->_fileno, LOCK_EX);
Â  Â  Â  Â  // ä»æ–‡ä»¶è¯»å–æ•°æ® [get_dataå‡½æ•°é‡Œä¼šå†æ¬¡æ‰“å¼€data_fileæ–‡ä»¶ï¼Œå¯¹åº”æ–°çš„fdï¼Œé”ä¸å…±ç”¨]
Â  Â  Â  Â  if (get_data(&data) < 0) continue;
Â  Â  Â  Â  // åŠ æ•°+1ï¼Œå¹¶åˆ¤æ–­åŠ æ•°æ˜¯å¦è¶…è¿‡èŒƒå›´
Â  Â  Â  Â  if (++data.now > end) {
Â  Â  Â  Â  Â  Â  fclose(f);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  // åšåŠ æ³•
Â  Â  Â  Â  data.sum += data.now;
Â  Â  Â  Â  printf("The <%d>th Child : now = %d, sum = %d\n", id, data.now, data.sum);
Â  Â  Â  Â  // å°†æ•°æ®å†™å…¥æ–‡ä»¶
Â  Â  Â  Â  if (set_data(&data) < 0) continue;
Â  Â  Â  Â  // è§£é” [åé¢å…³é—­å…¶å®ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾é”]
Â  Â  Â  Â  flock(fileno(f), LOCK_UN);
Â  Â  Â  Â  fclose(f);
Â  Â  Â  Â  */
Â  Â  }
}
int main(int argc, char **argv) {
Â  Â  int opt, start = 0, end = 0;
Â  Â  while ((opt = getopt(argc, argv, "s:e:")) != -1) {
Â  Â  Â  Â  switch (opt) {
Â  Â  Â  Â  Â  Â  case 's':
Â  Â  Â  Â  Â  Â  Â  Â  start = atoi(optarg);Â  Â  Â  Â // atoi: å­—ç¬¦ä¸²->æ•´æ•°
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'e':
Â  Â  Â  Â  Â  Â  Â  Â  end = atoi(optarg);
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  fprintf(stderr, "Usage : %s -s start_num -e end_num\n", argv[0]);
Â  Â  Â  Â  Â  Â  Â  Â  exit(1);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  printf("start = %d\nend = %d\n", start, end);
Â  Â  // å…ˆå°†åˆå§‹æ•°æ®å†™å…¥æ–‡ä»¶
Â  Â  if (set_data(&data) < 0) return -1;Â  Â  Â // dataä¸ºå…¨å±€å˜é‡ï¼Œæˆå‘˜é»˜è®¤å‡ä¸º0
Â  Â  pid_t pid;
Â  Â  int x = 0;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // x: ç¬¬å‡ å·è¿›ç¨‹
Â  Â  for (int i = 1; i <= INS; i++) {
Â  Â  Â  Â  if ((pid = fork()) < 0) {
Â  Â  Â  Â  Â  Â  perror("fork");
Â  Â  Â  Â  Â  Â  exit(1);Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // åªæ˜¯å›¾æ–¹ä¾¿ï¼Œå·¥ä½œä¸­ä¸å¦‚æ­¤æ“ä½œ
Â  Â  Â  Â  }
Â  Â  Â  Â  if (pid == 0) {
Â  Â  Â  Â  Â  Â  x = i;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ç»™å­è¿›ç¨‹ç¼–å·
Â  Â  Â  Â  Â  Â  break;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å…³é”®ï¼Œå¦åˆ™ä¼šä¸æ–­å¥—å¨ƒ
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (pid != 0) {
Â  Â  Â  Â  // é˜²æ­¢äº§ç”Ÿåƒµå°¸è¿›ç¨‹ [ç­‰å¾…å®Œæ‰€æœ‰çš„å­è¿›ç¨‹]
Â  Â  Â  Â  for (int i = 1; i <= INS; i++) {
Â  Â  Â  Â  Â  Â  wait(NULL);
Â  Â  Â  Â  }
Â  Â  Â  Â  if (get_data(&data) < 0) return -1; // è·å¾—æœ€ç»ˆç»“æœ
Â  Â  Â  Â  printf("sum = %d\n", data.sum);
Â  Â  } else {
Â  Â  Â  Â  do_add(end, x);Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // å­è¿›ç¨‹å”¯ä¸€çš„äº‹
Â  Â  }
Â  Â  return 0;
}
```
## head.h

```c++
#ifndef _HEAD_H
#define _HEAD_H
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <sys/time.h>
#include <sys/wait.h>
#include <sys/file.h>
#endif
```
* å¯èƒ½æœ‰å¤šä½™çš„å¤´æ–‡ä»¶ï¼Œä¸æ˜¯é‡ç‚¹
# å‚è€ƒ

* ä¸»è¦çŸ¥è¯†ç‚¹å‚è€ƒã€Šç½‘ç»œä¸ç³»ç»Ÿç¼–ç¨‹ã€‹
    * [0 è¯¾ç¨‹ä»‹ç»åŠå‘½ä»¤è¡Œè§£æå‡½æ•°](https://doublelll3.ml/wxb_0_%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0/)â€”â€”getopt
    * [1 æ–‡ä»¶ã€ç›®å½•æ“ä½œä¸å®ç°lsçš„æ€è·¯](https://doublelll3.ml/wxb_1_%E6%96%87%E4%BB%B6%E3%80%81%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C%E4%B8%8E%E5%AE%9E%E7%8E%B0ls%E7%9A%84%E6%80%9D%E8%B7%AF/)â€”â€”fopenã€freadã€fwrite
    * [3 å¤šè¿›ç¨‹](https://doublelll3.ml/wxb_3_å¤šè¿›ç¨‹/)â€”â€”forkã€waitã€flockâ­

